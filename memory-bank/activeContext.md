# Active Context

## Current Focus
BUILD: Демо-режим и изоляция данных (DEMO_MODE, tenant_id, управление техниками, ограничение 7 дней)

## Current Phase
BUILD Mode — Реализация демо-режима завершена, готово к тестированию

## Latest Changes (2025-12-15)
- ✅ Phase 11 (Demo Mode & Multi-Tenant Isolation) полностью реализована
- ✅ Добавлен DEMO_MODE=true для публичного доступа без allowlist
- ✅ Реализована изоляция данных через tenant_id (requests, complaints, warehouse_items)
- ✅ Добавлена проверка срока доступа (7 дней с момента первого /start)
- ✅ Создана модель TechnicianAssignment для связи руководитель-техник
- ✅ Реализован TechnicianService для управления техниками
- ✅ Добавлены handlers для управления техниками (добавление/удаление/просмотр)
- ✅ Техники работают с tenant_id руководителя (видят его заявки и склад)
- ✅ Техники принудительно работают как warehouseman (не могут быть руководителями)
- ✅ Обновлено приветственное сообщение с информацией о демо-режиме и оставшихся днях
- ✅ Добавлена таблица user_events для маркетингового трекинга (/start события)
- ✅ Улучшена обработка username при добавлении техника (понятные сообщения об ошибках)
- ✅ Создана миграция для technician_assignments и маркетинговых данных
- ✅ Обновлена документация (DEMO_MODE_SETUP.md)

## Previous Changes
- ✅ Phase 9 полностью реализована
- ✅ TaskScheduler для планирования задач (asyncio-based)
- ✅ AutomationService для автоматических проверок
- ✅ BUILD (2025-12-14): добавлено `BOT_PUBLIC_URL` и показ ссылки "Протестируйте бота" в /start
- ✅ BUILD (2025-12-14): во всех пользовательских текстах заменено "сотрудник"→"пользователь", "завхоз"→"техник"

## Next Steps
**Для продолжения разработки:**
- Тестирование демо-режима на локалке
- Применить миграции (`alembic upgrade head`)
- Проверить изоляцию данных между пользователями
- Проверить назначение техников и их работу с данными руководителя
- Проверить ограничение 7 дней доступа
- Phase 10: Deployment & Testing - деплой на прод (если нужно)

**Созданные файлы Phase 9:**
- `bot/services/automation_service.py` - сервис для автоматических проверок
- `bot/services/scheduler.py` - планировщик задач

**Основные компоненты:**
- Планировщик задач - asyncio-based, проверяет время каждую минуту
- Автоматические проверки - минимум на складе, срочные заявки, старые заявки
- Ежедневный отчет - автоматическая отправка статистики руководителю
- Предотвращение повторных запусков - флаги для каждой задачи
- Обработка ошибок - логирование ошибок без прерывания работы
