# Progress Tracking

## Current Status
Phase 11 ✅ COMPLETED → Готово к тестированию демо-режима на локалке

## Recent Updates (2025-12-15)
- ✅ Phase 11: Demo Mode & Multi-Tenant Isolation полностью реализована
- ✅ Добавлен DEMO_MODE=true для публичного доступа без allowlist
- ✅ Реализована изоляция данных через tenant_id (каждый пользователь = свой tenant_id в DEMO_MODE)
- ✅ Добавлена проверка срока доступа (7 дней с момента первого /start)
- ✅ Создана модель TechnicianAssignment для назначения техников руководителям
- ✅ Реализовано управление техниками (добавление по ID/username, удаление, просмотр списка)
- ✅ Техники работают с tenant_id руководителя (видят его заявки и склад)
- ✅ Техники принудительно работают как warehouseman (не могут быть руководителями)
- ✅ Обновлено приветственное сообщение с информацией о демо-режиме и оставшихся днях
- ✅ Добавлена таблица user_events для маркетингового трекинга (события /start)
- ✅ Создана миграция для technician_assignments и маркетинговых данных
- ✅ Обновлена документация (DEMO_MODE_SETUP.md)

## Previous Updates (2025-12-14)
- ✅ Добавлено переключение ролей для руководителя (кнопки: "Зайти как пользователь/техник/руководитель")
- ✅ Ребрендинг пользовательских текстов: "сотрудник"→"пользователь", "завхоз"→"техник"
- ✅ Добавлена переменная окружения `BOT_PUBLIC_URL` и ссылка "Протестируйте бота" в /start

## Completed
- [x] Memory Bank structure created
- [x] Technical specification analyzed
- [x] Planning completed (10 phases)
- [x] Creative design completed (FSM, Automation)
- [x] **Phase 1: Setup & Core Infrastructure**
  - [x] Project structure created
  - [x] Configuration files created
  - [x] Database models created (5 models)
  - [x] Alembic setup configured
- [x] **Phase 2: Role System & Basic Handlers**
  - [x] RoleService реализован
  - [x] RoleMiddleware создан
  - [x] Клавиатуры для всех ролей созданы
  - [x] Handler /start с меню по ролям
  - [x] Handler /settings для завхоза
  - [x] Handler "Помощь"
  - [x] Все handlers зарегистрированы в main.py
- [x] **Phase 3: Request Creation**
  - [x] FSM состояния для создания заявки
  - [x] RequestService для работы с заявками
  - [x] RequestCreationData dataclass
  - [x] Утилита генерации номера заявки (ЗХ-ДДММГГ-№№№)
  - [x] Все 6 шагов мастера реализованы
  - [x] Клавиатуры для категорий, приоритетов, фото
  - [x] Редактирование на этапе подтверждения
  - [x] Отмена на любом этапе
  - [x] Загрузка до 5 фото
  - [x] Условный шаг с количеством
- [x] **Phase 4: Employee Features**
  - [x] Просмотр своих заявок ("Мои заявки")
  - [x] Просмотр деталей заявки с фото
  - [x] Связь с завхозом (отправка сообщения)
  - [x] ComplaintService для работы с жалобами
  - [x] Мастер создания жалобы (2 шага)
  - [x] Уведомления руководителю и завхозу о жалобах
  - [x] Уведомление завхозу о новых заявках
  - [x] Форматирование заявок для отображения
- [x] **Phase 5: Warehouseman Features**
  - [x] WarehousemanService для работы с заявками
  - [x] Просмотр новых заявок с бейджиком количества
  - [x] Просмотр списков заявок (сегодня, неделя)
  - [x] Действия с заявками: взять в работу, выполнить, отклонить
  - [x] Отправка сообщений сотрудникам
  - [x] Уведомления сотрудникам об изменении статуса
  - [x] Обновление клавиатуры с актуальным количеством новых заявок
- [x] **Phase 6: Warehouse Management**
  - [x] WarehouseService для работы со складом
  - [x] Просмотр склада (список всех позиций)
  - [x] Добавление позиций на склад (название + минимальный остаток)
  - [x] Управление количеством (+ Приход, - Списать)
  - [x] Изменение минимального остатка
  - [x] Списание со склада при закрытии заявки
  - [x] Индикаторы низкого остатка (⚠️/✅)
- [x] **Phase 7: Broadcast & Settings**
  - [x] BroadcastService для рассылок
  - [x] Мастер создания рассылки (FSM: текст → подтверждение)
  - [x] Отправка рассылки всем сотрудникам
  - [x] Отчет о результатах рассылки (успешно/ошибки)
  - [x] Улучшенный handler настроек с инструкциями
- [x] **Phase 8: Manager Features**
  - [x] ManagerService для работы с заявками и жалобами
  - [x] Просмотр заявок за сегодня
  - [x] Просмотр заявок за неделю
  - [x] Фильтры заявок (в работе >3 дней, >7 дней)
  - [x] Отчет за период (FSM: начальная дата → конечная дата)
  - [x] Просмотр всех жалоб на завхоза
  - [x] Статистика по статусам в отчете
- [x] **Phase 9: Automation & Notifications**
  - [x] TaskScheduler для планирования задач (asyncio-based)
  - [x] AutomationService для автоматических проверок
  - [x] Проверка минимума на складе (8:30) - уведомление завхозу
  - [x] Ежедневный отчет руководителю (9:00) - отчет за предыдущий день
  - [x] Проверка срочных заявок (>2 часов) - уведомление руководителю
  - [x] Проверка заявок в работе >7 дней (10:00) - уведомление руководителю
  - [x] Уведомления о смене статуса (уже реализовано в handlers)
  - [x] Интеграция планировщика в main.py
- [x] **Phase 10: Role Branding & Onboarding**
  - [x] Переключение ролей для руководителя (кнопки: "Зайти как пользователь/техник/руководитель")
  - [x] Ребрендинг пользовательских текстов: "сотрудник"→"пользователь", "завхоз"→"техник"
  - [x] Добавлена переменная окружения `BOT_PUBLIC_URL` и ссылка "Протестируйте бота" в /start
  - [x] Руководитель может заходить на склад и управлять позициями (добавление/списание)
  - [x] Техник может только добавлять на склад, но не списывать
- [x] **Phase 11: Demo Mode & Multi-Tenant Isolation**
  - [x] Добавлен DEMO_MODE=true для публичного доступа без allowlist
  - [x] Реализована изоляция данных через tenant_id (requests, complaints, warehouse_items)
  - [x] Каждый пользователь в DEMO_MODE получает свой tenant_id = его Telegram ID
  - [x] Добавлена проверка срока доступа (7 дней с момента первого /start)
  - [x] Создана модель TechnicianAssignment для связи руководитель-техник
  - [x] Реализован TechnicianService для управления техниками
  - [x] Добавлены handlers для управления техниками (добавление/удаление/просмотр списка)
  - [x] Техники работают с tenant_id руководителя (видят его заявки и склад)
  - [x] Техники принудительно работают как warehouseman (не могут быть руководителями)
  - [x] Обновлено приветственное сообщение с информацией о демо-режиме и оставшихся днях
  - [x] Добавлена таблица user_events для маркетингового трекинга (события /start)
  - [x] Создана миграция для technician_assignments и маркетинговых данных
  - [x] Обновлена документация (DEMO_MODE_SETUP.md)

## In Progress
- Phase 11 завершена. Готово к тестированию демо-режима на локалке
- Требуется применить миграции: `alembic upgrade head`

## Pending
- Тестирование демо-режима на локалке
- Phase 10: Deployment & Testing (деплой на прод, если нужно)

